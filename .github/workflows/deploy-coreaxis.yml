name: Build & Deploy CoreAxis (self-hosted)

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    env:
      SITE_NAME: "VemBackend"
      SITE_PATH: "D:\\backend"
      PUBLISH_TEMP: "D:\\backend-new"
      BACKUP_ROOT: "D:\\deploy\\backups\\coreaxis"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Publish CoreAxis.ApiGateway
        shell: powershell
        run: |
          $projectPath = "src/ApiGateway/CoreAxis.ApiGateway/CoreAxis.ApiGateway.csproj"
          Write-Host "Publishing $projectPath to $env:PUBLISH_TEMP ..."
          dotnet publish $projectPath -c Release -o $env:PUBLISH_TEMP

      - name: Backup current version and swap to new build
        shell: powershell
        run: |
          Import-Module WebAdministration

          $siteName   = $env:SITE_NAME
          $sitePath   = $env:SITE_PATH
          $newPath    = $env:PUBLISH_TEMP
          $backupRoot = $env:BACKUP_ROOT

          $site = Get-Website | Where-Object { $_.Name -eq $siteName }
          if (-not $site) {
              Write-Error "Website $siteName not found, aborting deployment."
              exit 1
          }

          $appPoolName = $site.ApplicationPool
          Write-Host "Using application pool: $appPoolName"

          New-Item -ItemType Directory -Path $backupRoot -Force | Out-Null
          if (!(Test-Path $sitePath)) { New-Item -ItemType Directory -Path $sitePath -Force | Out-Null }

          $timestamp  = Get-Date -Format 'yyyyMMdd-HHmmss'
          $backupPath = Join-Path $backupRoot $timestamp
          Write-Host "Backing up $sitePath to $backupPath ..."
          Copy-Item "$sitePath\*" $backupPath -Recurse -Force -ErrorAction SilentlyContinue

          Write-Host "Stopping App Pool $appPoolName ..."
          Stop-WebAppPool -Name $appPoolName -ErrorAction SilentlyContinue

          Write-Host "Stopping IIS site $siteName ..."
          Stop-Website -Name $siteName -ErrorAction SilentlyContinue

          Start-Sleep -Seconds 3

          Write-Host "Clearing $sitePath (excluding .env) ..."
          Get-ChildItem $sitePath -Force |
            Where-Object { $_.Name -ne '.env' } |
            Remove-Item -Recurse -Force -ErrorAction SilentlyContinue

          Start-Sleep -Seconds 2

          $maxAttempts = 3
          $copyOk = $false

          for ($i = 1; $i -le $maxAttempts; $i++) {
              Write-Host ("Copy attempt {0}: from {1} to {2} ..." -f $i, $newPath, $sitePath)
              try {
                  Copy-Item "$newPath\*" $sitePath -Recurse -Force
                  $copyOk = $true
                  break
              }
              catch {
                  Write-Host ("Copy failed on attempt {0}: {1}" -f $i, $_.Exception.Message)
                  Start-Sleep -Seconds 2
              }
          }

          if (-not $copyOk) {
              Write-Error "Copy failed after $maxAttempts attempts. Aborting deployment."
              exit 1
          }

          Write-Host "Starting App Pool $appPoolName ..."
          Start-WebAppPool -Name $appPoolName -ErrorAction SilentlyContinue

          Write-Host "Starting IIS site $siteName ..."
          Start-Website -Name $siteName -ErrorAction SilentlyContinue

          Write-Host "Deployment DONE âœ…"
