name: Build & Deploy CoreAxis (self-hosted)

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    env:
      # IIS & paths
      SITE_NAME: "coreaxis"
      SITE_PATH: "D:\\backend"
      PUBLISH_TEMP: "D:\\backend-new"
      BACKUP_ROOT: "D:\\deploy\\backups\\coreaxis"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # اگر این workflow داخل خود coreAxis باشد،
        # نیازی به تنظیم repository نیست و همین کافی است.

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Publish CoreAxis.ApiGateway
        shell: pwsh
        run: |
          $projectPath = "src/ApiGateway/CoreAxis.ApiGateway/CoreAxis.ApiGateway.csproj"
          Write-Host "Publishing $projectPath to $env:PUBLISH_TEMP ..."
          dotnet publish $projectPath -c Release -o $env:PUBLISH_TEMP

      - name: Backup current version and swap to new build
        shell: pwsh
        run: |
          Import-Module WebAdministration

          $siteName   = $env:SITE_NAME
          $sitePath   = $env:SITE_PATH
          $newPath    = $env:PUBLISH_TEMP
          $backupRoot = $env:BACKUP_ROOT

          # اطمینان از وجود دایرکتوری‌ها
          New-Item -ItemType Directory -Path $backupRoot -Force | Out-Null
          if (!(Test-Path $sitePath)) { New-Item -ItemType Directory -Path $sitePath -Force | Out-Null }

          # بکاپ گرفتن از نسخه فعلی
          $timestamp  = Get-Date -Format 'yyyyMMdd-HHmmss'
          $backupPath = Join-Path $backupRoot $timestamp
          Write-Host "Backing up $sitePath to $backupPath ..."
          Copy-Item "$sitePath\*" $backupPath -Recurse -Force -ErrorAction SilentlyContinue

          # توقف سایت IIS
          Write-Host "Stopping IIS site $siteName ..."
          Stop-Website -Name $siteName -ErrorAction SilentlyContinue

          # خالی کردن مسیر فعلی
          Write-Host "Clearing $sitePath ..."
          Get-ChildItem $sitePath -Force | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue

          # کپی بیلد جدید
          Write-Host "Copying new build from $newPath to $sitePath ..."
          Copy-Item "$newPath\*" $sitePath -Recurse -Force

          # استارت دوباره سایت
          Write-Host "Starting IIS site $siteName ..."
          Start-Website -Name $siteName

          Write-Host "Deployment DONE ✅"
