{
  "schema_version": "1.0.0",
  "generated_at": "2025-12-22T10:29:42.202750",
  "package": {
    "name": "coreaxis_form_P0_fixpack_v2",
    "based_on_zip": "coreAxis-develop-1354.zip",
    "goal": "Finish FormSubmitted -> Workflow resume wiring and correlation propagation so it works in production (not only tests)."
  },
  "findings_in_zip": [
    "WorkflowModule.cs now subscribes to FormSubmitted, but FormSubmittedIntegrationEventHandler is NOT registered in DI.",
    "DynamicForm CreateSubmissionCommandHandler still publishes FormSubmitted with Guid.NewGuid() correlationId and does not pass WorkflowRunId/StepKey.",
    "FormSubmittedIntegrationEventHandler still derives workflowRunId only from Metadata and ignores the new WorkflowRunId property.",
    "FormWorkflowEndToEndTests still manually subscribe to FormSubmitted, hiding production wiring issues."
  ],
  "tasks": [
    {
      "id": "TASK-FORM-P0-V2-01",
      "title": "Register FormSubmittedIntegrationEventHandler in WorkflowModule DI",
      "priority": "P0",
      "why": "EventBus Subscribe<TEvent,THandler> usually resolves handler type from DI; without DI registration, handler won't run in production.",
      "what_to_do": [
        "In src/Modules/Workflow/Api/CoreAxis.Modules.Workflow.Api/WorkflowModule.cs add: services.AddTransient<FormSubmittedIntegrationEventHandler>();",
        "Confirm no duplicate registrations and module compiles."
      ],
      "acceptance_criteria": [
        "Application starts and can resolve FormSubmittedIntegrationEventHandler from DI.",
        "A FormSubmitted event triggers handler execution in runtime."
      ],
      "dependencies": []
    },
    {
      "id": "TASK-FORM-P0-V2-02",
      "title": "Use WorkflowRunId (explicit field) first in FormSubmittedIntegrationEventHandler; keep Metadata fallback",
      "priority": "P0",
      "why": "Relying on Metadata parsing is fragile; the event contract now supports WorkflowRunId explicitly.",
      "what_to_do": [
        "In FormSubmittedIntegrationEventHandler.cs set workflowRunId = @event.WorkflowRunId first.",
        "If null, fallback to current Metadata parsing behavior.",
        "Keep StepKey forwarding (if present) into resume input payload."
      ],
      "acceptance_criteria": [
        "When WorkflowRunId is present in event, handler resumes workflow without reading Metadata.",
        "Old events without WorkflowRunId still resume using Metadata (if it contains workflowRunId)."
      ],
      "dependencies": [
        "TASK-FORM-P0-V2-01"
      ]
    },
    {
      "id": "TASK-FORM-P0-V2-03",
      "title": "Publish FormSubmitted with correlationId from ICorrelationIdAccessor and include WorkflowRunId/StepKey when available",
      "priority": "P0",
      "why": "Correlation must be stable end-to-end; WorkflowRunId/StepKey should be explicit in event payload for reliable routing.",
      "what_to_do": [
        "In CreateSubmissionCommandHandler, replace Guid.NewGuid() with _correlationIdAccessor.GetCorrelationId().",
        "Extract workflowRunId and stepKey from request.Metadata if present (e.g., keys: 'workflowRunId' and 'stepKey').",
        "Pass workflowRunId and stepKey into new FormSubmitted(..., correlationId, workflowRunId, stepKey).",
        "Keep submission.Metadata JSON as-is for backward compatibility."
      ],
      "acceptance_criteria": [
        "FormSubmitted.CorrelationId equals request correlation id (header) when provided.",
        "FormSubmitted.WorkflowRunId is populated when request.Metadata contains it.",
        "No breaking changes for clients not sending workflow info."
      ],
      "dependencies": [
        "TASK-FORM-P0-V2-02"
      ]
    },
    {
      "id": "TASK-FORM-P0-V2-04",
      "title": "Make tests production-like: remove manual EventBus subscriptions and add assertions for correlation + resume",
      "priority": "P0",
      "why": "Current tests manually subscribe, masking production wiring problems.",
      "what_to_do": [
        "In FormWorkflowEndToEndTests.cs remove _eventBus.Subscribe<FormSubmitted>(handler) and rely on module wiring.",
        "Add a test case that emits a FormSubmitted with WorkflowRunId and confirms workflow resumes.",
        "If feasible: add an integration test that sets X-Correlation-Id header on submit and asserts published event uses it (or assert logs/captured events)."
      ],
      "acceptance_criteria": [
        "Tests pass without manual event subscriptions.",
        "At least one test covers WorkflowRunId-based resume.",
        "At least one test covers correlation id propagation."
      ],
      "dependencies": [
        "TASK-FORM-P0-V2-03"
      ]
    }
  ]
}