حتماً! در ادامه، راهنمای کامل و گام‌به‌گام توسعه‌ی ماژول **MLM (Multi-Level Marketing)** رو ارائه می‌دم، با در نظر گرفتن اصول زیرساخت CoreAxis که قبلاً پیاده‌سازی شده:

---

# ✅ **CoreAxis – MLM Module Development Guideline**

## 🎯 هدف کلی

ساخت یک ماژول ماژولار، تست‌پذیر، و مستقل برای مدیریت شبکهٔ کاربران و محاسبه و پرداخت کمیسیون‌های مرحله‌ای و پله‌ای، متناسب با معماری Clean و معماری رویدادمحور CoreAxis.

---

## 🧱 ساختار کلی ماژول

```
/CoreAxis.Modules.MLMModule
  ├── Domain
  │   ├── Entities
  │   ├── ValueObjects
  │   ├── Enums
  │   └── Events
  ├── Application
  │   ├── Commands
  │   ├── Queries
  │   ├── Services
  │   └── Interfaces
  ├── Infrastructure
  │   ├── Repositories
  │   └── EFConfigurations
  ├── API
  │   ├── Controllers
  │   └── DTOs
  ├── Resources
  │   └── Localization files (.resx)
  └── ModuleRegistration.cs
```

---

## 🪜 مراحل توسعه (و نکات مهم)

### 1. طراحی ساختار درختی MLM

* **Entity**: `UserReferral`
* فیلدها: `UserId`, `ParentUserId`, `Path`, `Level`, `CreatedAt`, 
* راهکار پیشنهادشده: **Materialized Path** برای قابلیت جستجوی سریع مسیر بالادستی.

### 2. تعریف قوانین کمیسیون

* **Entity**: `CommissionRuleSet`, `CommissionLevel`
* قابلیت‌ها:

  * تعریف قوانین به‌ازای هر محصول یا سطح کاربر
  * عمق دلخواه (سطح ۱ تا N)
  * محدودیت‌ها (مثلاً فقط اگر upline فعال باشه)

### 3. پیاده‌سازی موتور محاسبه کمیسیون

* Service در لایه Application: `CommissionCalculationService`
* ورودی: `PaymentConfirmedEvent`
* خروجی: `CommissionGeneratedEvent` برای هر سطح

### 4. ذخیره‌سازی تراکنش کمیسیون

* **Entity**: `CommissionTransaction`
* فیلدها: `UserId`, `Amount`, `Level`, `SourcePaymentId`, `Status`, `IsSettled`, `WalletTransactionId`, 

### 5. اتصال به Wallet Module

* از **Event Bus** استفاده کن (Publish `CommissionReadyToDepositEvent`)
* Wallet باید در پاسخ `WalletCreditedEvent` ارسال کنه

### 6. API عمومی برای نمایش کمیسیون‌ها

* Endpoint ها:

  * `/api/mlm/commissions/my`
  * `/api/mlm/commissions/{userId}` (فقط ادمین)
* فیلترها: تاریخ، وضعیت، سطح

### 7. تست و پوشش سناریوها

* واحد تست برای:

  * درخت MLM
  * اعمال قانون کمیسیون
  * ارسال رویدادها

---

## 📄 قراردادهای رویداد (Event Contracts)

### `PaymentConfirmedEvent`

```json
{
  "userId": "string",
  "amount": 250000,
  "paymentId": "guid",
  "productId": "guid",
}
```

### `CommissionGeneratedEvent`

```json
{
  "commissionId": "guid",
  "userId": "string",
  "amount": 15000,
  "level": 1,
  "sourcePaymentId": "guid",
}
```

---

## 🧪 پوشش تست پیشنهادی

| سناریو                                         | نوع تست     | جزئیات                     |
| ---------------------------------------------- | ----------- | -------------------------- |
| کاربر خرید می‌کند و ۳ سطح کمیسیون تولید می‌شود | Integration | تست گردش کامل              |
| کاربر upline غیرفعال است                       | Unit        | نباید کمیسیون بگیرد        |
| قانون محصول خاص override شده                   | Unit        | بررسی اعمال override       |
| تست ذخیره `CommissionTransaction`              | Unit        | بررسی audit     |
| اتصال به WalletModule                          | Integration | بررسی ارسال و دریافت event |

---

## 📋 قوانین توسعه و کیفیت

* همه چیز تست‌پذیر باشد (سرویس‌ها باید interface محور باشند).
* هیچ اشاره‌ی مستقیم به سایر ماژول‌ها (Wallet) به جز از طریق EventBus نباید باشد.
* رعایت کامل SOLID:

  * کمیسیون جدا از کاربر
  * Rule از CommissionEngine جدا
* هر ماژول فایل `README.md` داشته باشد (هدف، رویدادها، ساختار، تست).

---

## 📁 نمونه فایل README.md برای این ماژول

```markdown
# MLM Module

## Purpose
Handle user network, commission rules, and payout process in multi-level format.

## Domain Entities
- UserReferral
- CommissionRuleSet
- CommissionTransaction

## Events
- PaymentConfirmedEvent → triggers commission generation
- CommissionGeneratedEvent → triggers wallet deposit

## APIs
- [GET] /mlm/commissions/my
- [GET] /mlm/commissions/{userId}

## Tests
- Application unit tests
- API integration test

## Notes
- Localization supported (.resx)
```

---

{
  "MLMModuleTasks": {
    "Domain": {
      "UserReferral": {
        "task": "بررسی و بهینه‌سازی ساختار Materialized Path",
        "description": "ارزیابی عملکرد در سناریوهای تغییرات گسترده در سلسله‌مراتب، بررسی جایگزین‌های Closure Table و ارزیابی trade-off",
        "dependencies": [],
        "priority": "high"
      },
      "CommissionRules": {
        "task": "توسعه Rule Engine برای قوانین کمیسیون قابل پیکربندی",
        "description": "تعریف و پیاده‌سازی امکان مدیریت قوانین پویا بدون نیاز به تغییر کد، با پشتیبانی از ورژن‌بندی و شرایط پیچیده",
        "dependencies": [],
        "priority": "high"
      },
      "CommissionTransaction": {
        "task": "اصلاح مدل داده‌ای برای ذخیره‌سازی کامل تراکنش و حالت‌های جبران (compensation)",
        "description": "افزودن فیلدهای لازم برای ردیابی جبران‌ها، خطاها و وضعیت نهایی تراکنش‌ها",
        "dependencies": ["UserReferral", "CommissionRules"],
        "priority": "medium"
      }
    },
    "Application": {
      "CommissionCalculationService": {
        "task": "پیاده‌سازی محاسبات async با صف پیام و الگوی Saga",
        "description": "ارتقا سرویس محاسبه کمیسیون به async، مدیریت خطا، retry، جبران و انتشار رویدادها",
        "dependencies": ["Domain.CommissionRules", "Domain.CommissionTransaction"],
        "priority": "high"
      },
      "EventHandlers": {
        "task": "بهبود مدیریت رویدادها و تضمین atomicity با Outbox Pattern",
        "description": "استفاده از Outbox برای تضمین عدم از دست رفتن رویدادها و هماهنگی با Wallet Module",
        "dependencies": ["CommissionCalculationService"],
        "priority": "high"
      }
    },
    "Infrastructure": {
      "Repositories": {
        "task": "بهینه‌سازی کوئری‌ها برای Materialized Path و پیاده‌سازی نگاشت به Closure Table (در صورت نیاز)",
        "description": "بهبود عملکرد ذخیره و بازیابی سلسله‌مراتب و جستجوی مسیرها",
        "dependencies": ["Domain.UserReferral"],
        "priority": "medium"
      },
      "EFConfigurations": {
        "task": "توسعه Migrationها برای تغییرات مدل داده‌ای جدید",
        "description": "ایجاد اسکریپت‌های EF Core برای اعمال تغییرات جداول و ایندکس‌ها",
        "dependencies": ["Domain.CommissionTransaction"],
        "priority": "medium"
      }
    },
    "API": {
      "Endpoints": {
        "task": "طراحی و پیاده‌سازی APIهای فیلترشده کمیسیون (شخصی و ادمین)",
        "description": "افزودن کنترل دسترسی مبتنی بر Role، فیلترهای تاریخ، وضعیت و سطح کمیسیون",
        "dependencies": ["Application.CommissionCalculationService", "Auth & ACL"],
        "priority": "high"
      },
      "DTOs": {
        "task": "تعریف DTOهای جدید و نسخه‌بندی API",
        "description": "طراحی دقیق داده‌های ورودی و خروجی برای API، با پشتیبانی از backward compatibility",
        "dependencies": ["Endpoints"],
        "priority": "medium"
      }
    },
    "Testing": {
      "UnitTests": {
        "task": "نوشتن تست‌های واحد برای قوانین کمیسیون و ساختار درختی",
        "description": "پوشش کامل سناریوهای edge case و استثنایی",
        "dependencies": ["Domain.CommissionRules", "Domain.UserReferral"],
        "priority": "high"
      },
      "IntegrationTests": {
        "task": "تست یکپارچه‌سازی بین محاسبه کمیسیون، رویدادها و Wallet",
        "description": "تضمین صحت کل جریان، تست retry و جبران خطا",
        "dependencies": ["Application.CommissionCalculationService", "EventHandlers", "Wallet Module"],
        "priority": "high"
      },
      "LoadTests": {
        "task": "شبیه‌سازی بار ترافیکی بالا و تحلیل عملکرد",
        "description": "بررسی پایداری سیستم در شرایط پرترافیک و بهینه‌سازی‌های لازم",
        "dependencies": ["Application.CommissionCalculationService"],
        "priority": "medium"
      }
    },
    "Monitoring & Operations": {
      "Monitoring": {
        "task": "طراحی و پیاده‌سازی مانیتورینگ برای تراکنش‌ها و رویدادها",
        "description": "مانیتورینگ زمان پاسخ، خطاهای محاسبه و پرداخت کمیسیون با alerting",
        "dependencies": ["Application.CommissionCalculationService", "EventHandlers"],
        "priority": "medium"
      },
      "ErrorHandling": {
        "task": "مکانیزم‌های fallback، retry و escalation برای خطاهای پردازش کمیسیون",
        "description": "تعریف فرایندهای دقیق و اطلاع‌رسانی به تیم پشتیبانی در شرایط خطا",
        "dependencies": ["Application.CommissionCalculationService"],
        "priority": "high"
      }
    }
  }
}
